<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spring.hi_hello_spring.group.query.mapper.PeerReviewResultMapper">
    <!-- 동료 평과 결과 리스트 조회 -->
    <select id="getPeerReviewResult" resultType="PeerReviewResultAllQueryDTO">
        SELECT
            rr.employee_seq,
            rr.employee_num,                <!-- reviewee's employee_num -->
            d.department_name,              <!-- reviewee's department_name -->
            r.employee_name AS reviewer_name,  <!-- reviewer_name -->
            rr.employee_name AS reviewee_name,  <!-- reviewee_name -->
            SUM(pr.peer_review_score) AS peerReviewScoreSum,  <!-- total peer review score -->
            SUM(pl.peer_review_list_score) AS peerReviewScoreListSum  <!-- total peer review list score -->
        FROM
            employee rr                    <!-- reviewee -->
        JOIN department d ON rr.department_seq = d.department_seq  <!-- reviewee's department -->
        LEFT JOIN peer_review pr ON rr.employee_seq = pr.reviewee_seq  <!-- peer review for reviewee -->
        LEFT JOIN employee r ON pr.reviewer_seq = r.employee_seq  <!-- reviewer -->
        LEFT JOIN peer_review_list pl ON pr.peer_review_list_seq = pl.peer_review_list_seq  <!-- peer review list -->
        LEFT JOIN employee reviewee ON rr.employee_seq = reviewee.employee_seq  <!-- reviewee's name -->
        WHERE rr.employee_seq IN (
        SELECT gm.employee_seq
        FROM group_member gm
        WHERE gm.task_group_seq = #{taskGroupSeq}
        )
        GROUP BY
        rr.employee_num, d.department_name, r.employee_name, rr.employee_name
    </select>

    <!-- 동료 평가 결과 상세 조회 -->
    <resultMap id="PeerReviewResultDetail" type="PeerReviewResultDetailQueryDTO"> 
        <collection property="peerReviewListContent" ofType="java.lang.String" javaType="java.util.List"/>
        <collection property="peerReviewScore" ofType="java.lang.Integer" javaType="java.util.List"/>
    </resultMap>

    <select id="getPeerReviewResultDetail" resultMap="PeerReviewResultDetail">
        SELECT
        l.peer_review_list_content,
        r.peer_review_score
        FROM
        peer_review r
        JOIN peer_review_list l ON r.peer_review_list_seq = l.peer_review_list_seq
        JOIN group_member m ON m.employee_seq = r.reviewee_seq
        WHERE r.reviewee_seq = #{employeeSeq} <!-- 특정 피평가자의 employee_seq 조건 추가 -->
    </select>

</mapper>